name: Video Crop + Upload to Google Drive

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Video URL'
        required: true
      drive_folder_id:
        description: 'Google Drive folder ID to upload video'
        required: true
      video_name:
        description: 'Name for the uploaded video'
        required: true

jobs:
  process-video:
    runs-on: ubuntu-latest
    outputs:
      drive_url: ${{ steps.upload.outputs.drive_url }}

    steps:
      - name: Install FFmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg curl jq

      - name: Download video
        run: |
          wget -O input.mp4 "${{ github.event.inputs.video_url }}"

      - name: Crop top & bottom then scale
        run: |
          ffmpeg -i input.mp4 -vf "crop=1280:545,scale=1280:1080" output_final.mp4

      - name: Upload to Google Drive
        id: upload
        env:
          SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          DRIVE_FOLDER_ID: ${{ github.event.inputs.drive_folder_id }}
          VIDEO_NAME: ${{ github.event.inputs.video_name }}
        run: |
          # إنشاء ملف JSON للمفتاح
          echo "$SERVICE_ACCOUNT_JSON" > sa.json

          # الحصول على access token
          ACCESS_TOKEN=$(curl -s -X POST -H "Content-Type: application/json" \
            -d @sa.json \
            https://oauth2.googleapis.com/token \
            | jq -r '.access_token')

          # رفع الفيديو إلى Google Drive
          RESPONSE=$(curl -s -X POST \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -F "metadata={name :'$VIDEO_NAME', parents:['$DRIVE_FOLDER_ID']};type=application/json;charset=UTF-8" \
            -F "file=@output_final.mp4" \
            "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart")

          DRIVE_FILE_ID=$(echo $RESPONSE | jq -r '.id')
          echo "Uploaded file ID: $DRIVE_FILE_ID"
          echo "drive_url=https://drive.google.com/file/d/$DRIVE_FILE_ID/view" >> $GITHUB_OUTPUT

