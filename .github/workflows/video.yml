name: Video Crop + Upload to Google Drive

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Video URL'
        required: true
      drive_folder_id:
        description: 'Google Drive folder ID to upload video'
        required: true
      video_name:
        description: 'Name for the uploaded video'
        required: true

jobs:
  process-video:
    runs-on: ubuntu-latest
    outputs:
      drive_url: ${{ steps.upload.outputs.drive_url }}

    steps:
      - name: Install FFmpeg + Python deps
        run: |
          sudo apt update
          sudo apt install -y ffmpeg python3-pip
          pip3 install pyjwt requests

      - name: Download video
        run: |
          wget -O input.mp4 "${{ github.event.inputs.video_url }}"

      - name: Crop top & bottom then scale
        run: |
          ffmpeg -i input.mp4 -vf "crop=1280:545,scale=1280:1080" output_final.mp4

      - name: Upload to Google Drive
        id: upload
        env:
          SERVICE_ACCOUNT_JSON: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_JSON }}
          DRIVE_FOLDER_ID: ${{ github.event.inputs.drive_folder_id }}
          VIDEO_NAME: ${{ github.event.inputs.video_name }}
        run: |
          echo "$SERVICE_ACCOUNT_JSON" > sa.json

          python3 <<'EOF'
          import json, time, jwt, requests, os, sys

          # تحميل بيانات service account
          with open("sa.json") as f:
              sa = json.load(f)

          # إنشاء JWT
          now = int(time.time())
          payload = {
              "iss": sa["client_email"],
              "scope": "https://www.googleapis.com/auth/drive.file",
              "aud": sa["token_uri"],
              "iat": now,
              "exp": now + 3600,
          }

          jwt_token = jwt.encode(payload, sa["private_key"], algorithm="RS256")

          # طلب access token
          token_resp = requests.post(
              sa["token_uri"],
              data={
                  "grant_type": "urn:ietf:params:oauth:grant-type:jwt-bearer",
                  "assertion": jwt_token,
              },
          )

          if token_resp.status_code != 200:
              print("Token error:", token_resp.text)
              sys.exit(1)

          access_token = token_resp.json()["access_token"]

          # headers الصحيحة
          headers = {
              "Authorization": f"Bearer {access_token}"
          }

          # metadata
          metadata = {
              "name": os.environ["VIDEO_NAME"],
              "parents": [os.environ["DRIVE_FOLDER_ID"]],
          }

          files = {
              "metadata": ("metadata", json.dumps(metadata), "application/json"),
              "file": open("output_final.mp4", "rb"),
          }

          # رفع الملف
          upload = requests.post(
              "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",
              headers=headers,
              files=files,
          )

          result = upload.json()
          print("Drive response:", result)

          file_id = result.get("id")
          if not file_id:
              print("Upload failed")
              sys.exit(1)

          print("Uploaded file ID:", file_id)

          # إخراج الرابط
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"drive_url=https://drive.google.com/file/d/{file_id}/view\n")
          EOF
