name: Video Crop + Waveform + Upload to Google Drive

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Video URL'
        required: true
      drive_folder_id:
        description: 'Google Drive folder ID to upload video'
        required: true
      video_name:
        description: 'Name for the uploaded video'
        required: true

jobs:
  process-video:
    runs-on: ubuntu-latest
    outputs:
      drive_url: ${{ steps.upload.outputs.drive_url }}

    steps:
      - name: Install FFmpeg + Python deps
        run: |
          sudo apt update
          sudo apt install -y wget python3-pip
          pip3 install requests

      - name: Download FFmpeg 7 static
        run: |
          wget -O ffmpeg-7.0.2-amd64-static.tar.xz https://johnvansickle.com/ffmpeg/releases/ffmpeg-7.0.2-amd64-static.tar.xz
          tar -xf ffmpeg-7.0.2-amd64-static.tar.xz
          chmod +x ./ffmpeg-7.0.2-amd64-static/ffmpeg

      - name: Download video
        run: |
          wget -O input.mp4 "${{ github.event.inputs.video_url }}"

      - name: Crop top & bottom then scale
        run: |
          ./ffmpeg-7.0.2-amd64-static/ffmpeg -i input.mp4 -vf "crop=in_w:545,scale=1280:720,setsar=1" output_cropped.mp4

      - name: Add waveform overlay
        run: |
          ./ffmpeg-7.0.2-amd64-static/ffmpeg -i output_cropped.mp4 -filter_complex "\
          [0:a]compand,showwaves=s=629x8:colors=white@1:draw=full:mode=p2p,format=yuva420p[wave]; \
          [0:v][wave]overlay=x=541:y=616:format=auto,format=yuv420p[outv]" \
          -map "[outv]" -map 0:a -c:v libx264 -c:a copy output_final.mp4

      - name: Upload to Google Drive
        id: upload
        env:
          CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          REFRESH_TOKEN: ${{ secrets.GOOGLE_REFRESH_TOKEN }}
          DRIVE_FOLDER_ID: ${{ github.event.inputs.drive_folder_id }}
          VIDEO_NAME: ${{ github.event.inputs.video_name }}
        run: |
          python3 <<'EOF'
          import os, requests, json, sys

          client_id = os.environ["CLIENT_ID"]
          client_secret = os.environ["CLIENT_SECRET"]
          refresh_token = os.environ["REFRESH_TOKEN"]
          folder_id = os.environ["DRIVE_FOLDER_ID"]
          video_name = os.environ["VIDEO_NAME"]

          # طلب access_token جديد باستخدام refresh_token
          token_resp = requests.post(
              "https://oauth2.googleapis.com/token",
              data={
                  "client_id": client_id,
                  "client_secret": client_secret,
                  "refresh_token": refresh_token,
                  "grant_type": "refresh_token"
              }
          )

          if token_resp.status_code != 200:
              print("Token error:", token_resp.text)
              sys.exit(1)

          access_token = token_resp.json()["access_token"]
          headers = {"Authorization": f"Bearer {access_token}"}

          # البحث عن أي ملف بنفس الاسم في المجلد المحدد وحذفه
          search_url = f"https://www.googleapis.com/drive/v3/files?q=name='{video_name}' and '{folder_id}' in parents&fields=files(id,name)"
          resp = requests.get(search_url, headers=headers)
          if resp.status_code == 200:
              files = resp.json().get("files", [])
              for f in files:
                  delete_url = f"https://www.googleapis.com/drive/v3/files/{f['id']}"
                  del_resp = requests.delete(delete_url, headers=headers)
                  if del_resp.status_code in [204, 200]:
                      print(f"Deleted existing file: {f['name']}")
                  else:
                      print(f"Failed to delete {f['name']}: {del_resp.text}")
          else:
              print("Search failed:", resp.text)

          # رفع الفيديو الجديد
          metadata = {
              "name": video_name,
              "parents": [folder_id],
          }

          files = {
              "metadata": ("metadata", json.dumps(metadata), "application/json"),
              "file": open("output_final.mp4", "rb"),
          }

          upload = requests.post(
              "https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",
              headers=headers,
              files=files,
          )

          result = upload.json()
          print("Drive response:", result)

          file_id = result.get("id")
          if not file_id:
              print("Upload failed")
              sys.exit(1)

          # إخراج رابط الفيديو النهائي
          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"drive_url=https://drive.google.com/file/d/{file_id}/view\n")
          EOF
